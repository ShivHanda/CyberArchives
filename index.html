<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CyberArchives - Threat Vault</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="//unpkg.com/three"></script>
    <script src="//unpkg.com/globe.gl"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Share Tech Mono', monospace; }

        /* --- LOADER SCREEN STYLES --- */
        #loader-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ff3333;
        }

        .cyber-box {
            border: 1px solid #ff3333;
            padding: 40px;
            width: 300px;
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.2);
            background: rgba(10, 0, 0, 0.9);
        }

        .cyber-title { font-size: 24px; margin-bottom: 20px; letter-spacing: 2px; text-shadow: 0 0 5px red; }
        
        .progress-container {
            width: 100%; height: 4px; background: #330000; margin: 20px 0;
            position: relative;
        }
        
        #progress-bar {
            width: 0%; height: 100%; background: #ff3333;
            box-shadow: 0 0 10px #ff3333;
            transition: width 0.2s ease;
        }

        #log-text { font-size: 12px; color: #aa5555; margin-top: 10px; min-height: 15px; }

        /* --- MAIN UI (Hidden initially) --- */
        #main-interface { opacity: 0; transition: opacity 1s ease; }
        
        #overlay {
            position: absolute; top: 20px; left: 20px;
            color: #ff3333; z-index: 100;
            background: rgba(10, 0, 0, 0.8);
            padding: 20px; border: 1px solid #330000;
            backdrop-filter: blur(4px);
        }
        
        .stats { margin-top: 10px; font-size: 14px; color: #cc8888; }
    </style>
</head>
<body>

    <div id="loader-screen">
        <div class="cyber-box">
            <div class="cyber-title">SYSTEM BOOT</div>
            <div style="font-size: 12px; color: #fff;">DECRYPTING ARCHIVES...</div>
            
            <div class="progress-container">
                <div id="progress-bar"></div>
            </div>
            
            <div id="log-text">INITIALIZING UPLINK...</div>
            <div id="percent-text" style="color: #fff; margin-top: 5px;">0%</div>
        </div>
    </div>

    <div id="main-interface">
        <div id="overlay">
            <h1 style="margin: 0; font-size: 24px; text-shadow: 0 0 10px red;">CYBER ARCHIVES</h1>
            <div class="stats">
                VAULT STATUS: <span style="color:#0f0">UNLOCKED</span><br>
                DISPLAYING: LATEST <span id="count-display">0</span> THREATS
            </div>
        </div>
        <div id="globeViz"></div>
    </div>

    <script>
        const CSV_URL = './threat_data.csv'; 

        // Initialize Globe
        const world = Globe()
            (document.getElementById('globeViz'))
            .backgroundColor('#020204')
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
            .atmosphereColor('#ff0000') 
            .atmosphereAltitude(0.15)
            .pointsData([])
            .labelsData([]);

        // Helper: IP Locator
        async function fetchLocation(ip) {
            try {
                // Using ipwho.is (HTTPS supported)
                const response = await fetch(`https://ipwho.is/${ip}`);
                const data = await response.json();
                if(data.success) {
                    return { lat: data.latitude, lon: data.longitude, city: data.city };
                }
            } catch (e) {
                console.error("Locating failed:", ip);
            }
            return null;
        }

        function loadData() {
            const logText = document.getElementById('log-text');
            const progressBar = document.getElementById('progress-bar');
            const percentText = document.getElementById('percent-text');

            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: async function(results) {
                    const rows = results.data;
                    const validRows = rows.filter(r => r.IP && r.IP.includes('.'));
                    
                    // Get Latest 50
                    const latest50 = validRows.reverse().slice(0, 50);
                    const plotData = [];
                    
                    logText.innerText = `FOUND ${latest50.length} RECORDS. TRIANGULATING...`;

                    // --- SEQUENTIAL LOADING LOOP ---
                    for (let i = 0; i < latest50.length; i++) {
                        const row = latest50[i];
                        
                        // Update Loader UI
                        const percent = Math.round(((i + 1) / latest50.length) * 100);
                        progressBar.style.width = `${percent}%`;
                        percentText.innerText = `${percent}%`;
                        logText.innerText = `LOCATING: ${row.IP}...`;

                        // Fetch Logic
                        const loc = await fetchLocation(row.IP);
                        
                        if (loc) {
                            plotData.push({
                                lat: loc.lat,
                                lon: loc.lon,
                                label: `${row.IP} (${loc.city})`,
                                alt: (parseInt(row.Confidence_Score || 50) / 100) * 0.4
                            });
                        }
                        
                        // Thoda delay taaki "Animation" feel aaye aur API block na kare
                        await new Promise(r => setTimeout(r, 150)); 
                    }

                    // --- FINAL RENDER ---
                    logText.innerText = "ACCESS GRANTED.";
                    
                    // 1. Update Globe Data
                    world.pointsData(plotData)
                         .pointLat(d => d.lat)
                         .pointLng(d => d.lon)
                         .pointColor(() => '#ff0000')
                         .pointAltitude(d => d.alt)
                         .pointRadius(0.5);

                    world.labelsData(plotData)
                         .labelLat(d => d.lat)
                         .labelLng(d => d.lon)
                         .labelText(d => d.label)
                         .labelSize(0.8)
                         .labelDotRadius(0.3)
                         .labelColor(() => '#ffaaaa')
                         .labelAltitude(d => d.alt + 0.01);

                    // 2. Hide Loader & Show Interface
                    setTimeout(() => {
                        document.getElementById('loader-screen').style.opacity = '0';
                        document.getElementById('main-interface').style.opacity = '1';
                        document.getElementById('count-display').innerText = plotData.length;
                        
                        // Remove loader from DOM after fade out
                        setTimeout(() => {
                            document.getElementById('loader-screen').style.display = 'none';
                        }, 1000);
                        
                    }, 500); // Small pause at 100%
                }
            });
        }

        // Start
        loadData();
        
        world.controls().autoRotate = true;
        world.controls().autoRotateSpeed = 0.5;
    </script>
</body>
</html>
